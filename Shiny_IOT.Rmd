---
title: "Shiny_IOT"
author: "Benito Pastor Sanchez"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(shiny)
library(ggplot2)

# Ruta al archivo CSV generado por Python
archivo_csv <- "monitorizacion.csv"

# Interfaz de usuario
ui <- fluidPage(
  titlePanel("Monitorización en Tiempo Real"),
  sidebarLayout(
    sidebarPanel(
      h4("Estado de los Sensores"),
      textOutput("ultimo_tideal"),
      textOutput("ultimo_incendio")
    ),
    mainPanel(
      plotOutput("grafica_temperatura", height = "300px"),
      plotOutput("grafica_particulas", height = "300px")
    )
  )
)

# Lógica del servidor
server <- function(input, output, session) {
  # Leer el archivo CSV en tiempo real
  datos <- reactiveFileReader(
    intervalMillis = 1000,
    session = session,
    filePath = archivo_csv,
    readFunc = read.csv
  )
  
  # Mostrar el último valor de tideal y estado de incendio
  output$ultimo_tideal <- renderText({
    df <- datos()
    if (nrow(df) > 0) {
      paste("Última Temperatura Ideal:", tail(df$tideal, 1))
    } else {
      "Esperando datos..."
    }
  })
  
  output$ultimo_incendio <- renderText({
    df <- datos()
    if (nrow(df) > 0) {
      paste("Estado de Incendio:", tail(df$incendio, 1))
    } else {
      "Esperando datos..."
    }
  })
  
  output$grafica_temperatura <- renderPlot({
  df <- datos()
  if (nrow(df) > 1) {  # Asegúrate de que hay más de un punto
    ggplot(df, aes(x = as.POSIXct(timestamp, format="%Y-%m-%d %H:%M:%S"), y = temperatura, group = 1)) +
      geom_line(color = "blue") +
      geom_point(color = "blue") +  # Agregar puntos
      labs(title = "Temperatura en Tiempo Real", x = "Tiempo", y = "Temperatura (°C)") +
      theme_minimal()
  } else {
    print("Esperando más datos para graficar.")
  }
})

output$grafica_particulas <- renderPlot({
  df <- datos()
  if (nrow(df) > 1) {  # Asegúrate de que hay más de un punto
    ggplot(df, aes(x = as.POSIXct(timestamp, format="%Y-%m-%d %H:%M:%S"), y = particulas, group = 1)) +
      geom_line(color = "red") +
      geom_point(color = "red") +  # Agregar puntos
      labs(title = "Concentración de Partículas en Tiempo Real", x = "Tiempo", y = "Partículas") +
      theme_minimal()
  } else {
    print("Esperando más datos para graficar.")
  }
})

}

# Ejecutar la aplicación
shinyApp(ui = ui, server = server)
```

